{"version":3,"sources":["commands/generate_commands/classdef.js"],"names":["builder","generateAnyDefinition","generateDefinition","handler","path","fs","_","writeFileFromTemplate","getConfiguration","getDataConfiguration","SimpleDataContext","getBuilder","command","desc","yargs","option","default","describe","argv","options","config","sources","getEdm","then","schema","console","log","name","entityType","map","x","Object","assign","split","Promise","all","ignoreOther","resolve","reject","test","error","Error","context","emptyModel","upperFirst","camelCase","fields","attributes","inherits","dataTypes","model","imports","inheritsClassPath","concat","dasherize","push","forEach","dataType","type","typeName","many","hasOwnProperty","nullable","importModel","find","destFile","destPath","process","cwd","base","existsSync","silent","templateFile","__dirname","destFolder","dirname","ensureDir","err","generateExtra","filter","catch","exit"],"mappings":"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","file":"classdef.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2017, THEMOST LP All rights reserved\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\nimport path from 'path';\nimport fs from 'fs-extra';\nimport _ from 'lodash';\nimport { writeFileFromTemplate, getConfiguration, getDataConfiguration, SimpleDataContext, getBuilder } from '../../util';\n\nexport const command = 'classdef <name>';\n\nexport const desc = 'Generate a new data model class definition';\n\nexport function builder(yargs) {\n    return yargs.option('silent', {\n        default: false,\n        describe: 'disable errors'\n    });\n}\n\nexport function generateAnyDefinition(argv) {\n    \n    //get cli options\n    let options = getConfiguration();\n    //get data configuration\n    let config = getDataConfiguration(options);\n    //get OData Builder\n    let builder = getBuilder(config);\n    let sources = [];\n    return builder.getEdm().then((schema)=> {\n        console.log('INFO', argv);\n        if (argv.name === 'app' || argv.name === '*') {\n            sources = schema.entityType.map((x)=> {\n                return generateDefinition(Object.assign({}, argv, {\n                    \"name\": x.name,\n                    \"silent\": true,\n                    \"ignoreOther\": true\n                }));\n            });\n        }\n        else {\n            sources = argv.name.split('+').map((x)=> {\n                return generateDefinition(Object.assign({}, argv, {\n                    \"name\": x,\n                    \"silent\": true,\n                    \"ignoreOther\": true\n                }));\n            });\n        }\n        return Promise.all(sources);\n    });\n    \n}\n\nexport function generateDefinition(argv, ignoreOther) {\n    return new Promise((resolve, reject) => {\n        let options = getConfiguration();\n        let config = getDataConfiguration(options);\n        //validating name\n        if (!/^[a-zA-Z0-9_-]+$/.test(argv.name)) {\n            console.error('ERROR', 'An error occurred while validating class name.');\n            return reject(new Error('Class name is not valid. Expected only latin characters, numbers or \"_,-\" characters.'));\n        }\n        //--\n        let context = new SimpleDataContext(config);\n        //get OData Builder\n        let builder = getBuilder(config);\n        return builder.getEdm().then((schema)=> {\n            //get model definition\n            let emptyModel = {\n                    name: _.upperFirst(_.camelCase(argv.name)),\n                    fields: [],\n                    attributes:[],\n                    inherits: null\n                };\n            let dataTypes = config.getDataConfiguration().dataTypes;\n            let model = context.model(argv.name) || emptyModel;\n            model.inherits = model.inherits || null; \n            model.imports = [];\n            if (model.inherits) {\n                model.inheritsClassPath = \"./\".concat(_.dasherize(model.inherits).concat('-model'));\n                model.imports.push({\n                  \"name\": model.inherits,\n                  \"from\": model.inheritsClassPath\n                });\n            }\n            else {\n                model.imports.push({\n                  \"name\": \"DataObject\",\n                  \"from\": \"@themost/data/data-object\"\n                });\n            }\n            model.attributes.forEach((x)=> {\n               //format data type\n                let dataType = dataTypes[x.type];\n                if (typeof x.type === 'undefined') {\n                    x.typeName = x.many ?  \"Array<*>\" : \"*\";\n                    return;\n                }\n                if (!x.hasOwnProperty('nullable')) {\n                    x.nullable = true;\n                }\n                //add import\n                if (x.model === model.name) {\n                    let importModel = context.model(x.type);\n                    if (importModel && importModel.name !== model.name) {\n                        if (typeof model.imports.find((x)=> { return x.name === importModel.name }) === 'undefined') {\n                            model.imports.push({\n                                \"name\": importModel.name,\n                                \"from\": \"./\".concat(_.dasherize(importModel.name).concat('-model'))\n                            });    \n                        }\n                    }    \n                }\n                if (dataType) {\n                    x.typeName = x.many ?  \"Array<\" + dataType.type + \">\" : dataType.type;\n                    return;\n                }\n                \n                x.typeName = x.many ?  \"Array<\" + x.type + \">\" : x.type;\n            });\n            //get file name\n            let destFile = _.dasherize(argv.name).concat('-model.d.ts');\n            console.log('INFO', `Generating class ${destFile}`);\n            let destPath = path.resolve(process.cwd(), options.base, `models/${destFile}`);\n            console.log('INFO', `Validating class path ${destPath}`);\n            if (fs.existsSync(destPath)) {\n                if (argv.silent) {\n                    console.error('WARNING', `The specified class [${argv.name}] already exists.`);\n                    return resolve();\n                }\n                console.error('ERROR', 'An error occurred while validating class definition.');\n                return reject(new Error('The specified class already exists.'));\n            }\n            //get template file path\n            let templateFile = path.resolve(__dirname, '../../../templates/generate/classdef.d.ts.ejs');\n            //get destination folder path\n            let destFolder = path.dirname(destPath);\n            console.error('INFO', `Validating class folder (${destFolder}).`);\n            fs.ensureDir(destFolder, (err) => {\n                if (err) {\n                    console.error('ERROR', 'An error occurred while validating destination path.');\n                    return reject(err);\n                }\n                writeFileFromTemplate(templateFile, destPath, model).then(() => {\n                    console.log('INFO', 'The operation was completed succesfully.');\n                    if (ignoreOther) {\n                        return resolve();\n                    }\n                    let generateExtra = model.imports.filter((x)=> {\n                       return x.name !== \"DataObject\"; \n                    }).map((x)=> {\n                        return generateDefinition(Object.assign({}, argv, {\n                            \"name\": x.name,\n                            \"silent\": true\n                        }));\n                    });\n                    Promise.all(generateExtra).then(()=> {\n                        return resolve();\n                    }).catch((err)=> {\n                        return reject(err);\n                    });\n                }).catch((err) => {\n                    console.error('ERROR', 'An error occurred while generating data model class.');\n                    return reject(err);\n                });\n    \n            }); \n        });\n    });\n}\n\nexport function handler(argv) {\n    generateAnyDefinition(argv).then(() => {\n        return process.exit(0);\n    }).catch((err) => {\n        console.error(err);\n        return process.exit(1);\n    });\n}"]}