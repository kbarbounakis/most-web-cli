{"version":3,"sources":["commands/generate_commands/class.js"],"names":["builder","generateAnyClass","generateClass","handler","path","fs","_","writeFileFromTemplate","getConfiguration","getDataConfiguration","SimpleDataContext","getBuilder","command","desc","yargs","option","default","describe","argv","options","config","sources","getEdm","then","schema","console","log","name","entityType","map","x","Object","assign","inProcClass","split","Promise","all","ignoreOther","resolve","reject","test","error","Error","context","indexOf","emptyModel","upperFirst","camelCase","fields","attributes","inherits","dataTypes","model","imports","inheritsClassPath","concat","dasherize","push","forEach","dataType","type","typeName","many","hasOwnProperty","nullable","importModel","find","destFile","mode","destPath","process","cwd","base","existsSync","force","silent","templateFile","__dirname","destFolder","dirname","ensureDir","err","generateExtra","filter","catch","exit"],"mappings":"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","file":"class.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2017, THEMOST LP All rights reserved\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\nimport path from 'path';\nimport fs from 'fs-extra';\nimport _ from 'lodash';\nimport { writeFileFromTemplate, getConfiguration, getDataConfiguration, SimpleDataContext, getBuilder } from '../../util';\n\nexport const command = 'class <name>';\n\nexport const desc = 'Generate a new data model class';\n\nexport function builder(yargs) {\n    return yargs.option('silent', {\n        default: false,\n        describe: 'disable errors'\n    }).option('force', {\n        default: false,\n        describe: 'replace if exists'\n    });\n}\n\nexport function generateAnyClass(argv) {\n    \n    //get cli options\n    let options = getConfiguration();\n    //get data configuration\n    let config = getDataConfiguration(options);\n    //get OData Builder\n    let builder = getBuilder(config);\n    let sources = [];\n    return builder.getEdm().then((schema)=> {\n        console.log('INFO', argv);\n        if (argv.name === 'app' || argv.name === '*') {\n            sources = schema.entityType.map((x)=> {\n                return generateClass(Object.assign({\n                    inProcClass:[]\n                }, argv, {\n                    \"name\": x.name,\n                    \"silent\": true\n                }), true);\n            });\n        }\n        else {\n            sources = argv.name.split('+').map((x)=> {\n                return generateClass(Object.assign({\n                    inProcClass:[]\n                }, argv, {\n                    \"name\": x,\n                    \"silent\": true\n                }), false);\n            });\n        }\n        return Promise.all(sources);\n    });\n    \n}\n\nexport function generateClass(argv, ignoreOther) {\n    return new Promise((resolve, reject) => {\n        //get cli options\n        let options = getConfiguration();\n        //get data configuration\n        let config = getDataConfiguration(options);\n        //validating name\n        if (!/^[a-zA-Z0-9_-]+$/.test(argv.name)) {\n            console.error('ERROR', 'An error occurred while validating class name.');\n            return reject(new Error('Class name is not valid. Expected only latin characters, numbers or \"_,-\" characters.'));\n        }\n        //--\n        let context = new SimpleDataContext(config);\n        argv.inProcClass = argv.inProcClass || [];\n        if (argv.inProcClass.indexOf(argv.name)>=0) {\n            return resolve();\n        }\n        //get OData Builder\n        let builder = getBuilder(config);\n        return builder.getEdm().then((schema)=> {\n                //get model definition\n                let emptyModel = {\n                        name: _.upperFirst(_.camelCase(argv.name)),\n                        fields: [],\n                        attributes:[],\n                        inherits: null\n                    };\n                let dataTypes = config.getDataConfiguration().dataTypes;\n                let model = context.model(argv.name) || emptyModel;\n                model.inherits = model.inherits || null; \n                model.imports = [];\n                if (model.inherits) {\n                    model.inheritsClassPath = \"./\".concat(_.dasherize(model.inherits).concat('-model'));\n                    model.imports.push({\n                      \"name\": model.inherits,\n                      \"from\": model.inheritsClassPath\n                    });\n                }\n                else {\n                    model.imports.push({\n                      \"name\": \"{DataObject}\",\n                      \"from\": \"@themost/data/data-object\"\n                    });\n                }\n                model.attributes.forEach((x)=> {\n                   //format data type\n                    let dataType = dataTypes[x.type];\n                    if (typeof x.type === 'undefined') {\n                        x.typeName = x.many ?  \"Array<*>\" : \"*\";\n                        return;\n                    }\n                    if (!x.hasOwnProperty('nullable')) {\n                        x.nullable = true;\n                    }\n                    //add import\n                    if (x.model === model.name) {\n                        let importModel = context.model(x.type);\n                        if (importModel && importModel.name !== model.name) {\n                            if (typeof model.imports.find((x)=> { return x.name === importModel.name }) === 'undefined') {\n                                model.imports.push({\n                                    \"name\": importModel.name,\n                                    \"from\": \"./\".concat(_.dasherize(importModel.name).concat('-model'))\n                                });    \n                            }\n                            x.typeName = x.many ?  \"Array<\" + x.type + \"|any>\" : x.type + \"|any\";\n                            return;\n                        }    \n                    }\n                    if (dataType) {\n                        x.typeName = x.many ?  \"Array<\" + dataType.type + \">\" : dataType.type;\n                        return;\n                    }\n                    x.typeName = x.many ?  \"Array<\" + x.type + \">\" : x.type;\n                });\n                //get file name\n                let destFile = _.dasherize(argv.name).concat('-model').concat(options.mode==='typescript' ? '.ts': '.js');\n                console.log('INFO', `Generating class ${destFile}`);\n                let destPath = path.resolve(process.cwd(), options.base, `models/${destFile}`);\n                console.log('INFO', `Validating class path ${destPath}`);\n                if (fs.existsSync(destPath) && !argv.force) {\n                    if (argv.silent) {\n                        console.error('WARNING', `The specified class [${argv.name}] already exists.`);\n                        return resolve();\n                    }\n                    console.error('ERROR', 'An error occurred while validating class.');\n                    return reject(new Error('The specified class already exists.'));\n                }\n                //get template file path\n                let templateFile = path.resolve(__dirname, '../../../templates/generate/class'+(options.mode==='typescript' ? '.ts': '.js')+'.ejs');\n                //get destination folder path\n                let destFolder = path.dirname(destPath);\n                console.error('INFO', `Validating class folder (${destFolder}).`);\n                fs.ensureDir(destFolder, (err) => {\n                    if (err) {\n                        console.error('ERROR', 'An error occurred while validating destination path.');\n                        return reject(err);\n                    }\n                    writeFileFromTemplate(templateFile, destPath, model).then(() => {\n                        console.log('INFO', 'The operation was completed succesfully.');\n                        if (ignoreOther) {\n                            return resolve();\n                        }\n                        //add in-process class\n                        argv.inProcClass.push(model.name);\n                        let generateExtra = model.imports.filter((x)=> {\n                           return x.name !== \"{DataObject}\" && x.name !== model.name;\n                        }).map((x)=> {\n                            return generateClass(Object.assign({}, argv, {\n                                    \"name\": x.name,\n                                    \"silent\": true\n                                }));\n                        });\n                        Promise.all(generateExtra).then(()=> {\n                            if (options.mode==='typescript') {\n                                return resolve();\n                            }\n                            return resolve();\n                        }).catch((err)=> {\n                            return reject(err);\n                        });\n                    }).catch((err) => {\n                        console.error('ERROR', 'An error occurred while generating data model class.');\n                        return reject(err);\n                    });\n                });\n        });\n    });\n}\n\nexport function handler(argv) {\n    generateAnyClass(argv).then(() => {\n        return process.exit(0);\n    }).catch((err) => {\n        console.error(err);\n        return process.exit(1);\n    });\n}\n"]}