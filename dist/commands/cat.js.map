{"version":3,"sources":["commands/cat.js"],"names":["builder","handler","getConfiguration","getHttpApplication","path","fs","QUERY_OPTS","command","desc","yargs","option","describe","default","choices","argv","options","model","console","error","process","exit","dev","env","NODE_ENV","app","execute","context","query","forEach","x","hasOwnProperty","filter","err","q","source","count","silent","getList","getItems","then","res","finalResult","top","state","Array","isArray","$state","out","outFile","resolve","cwd","writeFile","JSON","stringify","log","catch"],"mappings":"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","file":"cat.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2017, THEMOST LP All rights reserved\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\nimport {getConfiguration, getHttpApplication} from '../util';\nimport path from 'path';\nimport fs from 'fs-extra';\n\n\nconst QUERY_OPTS = ['filter', 'expand', 'order', 'group', 'top', 'skip', 'count', 'select'];\n\nexport const command = 'cat <model> [options]';\n\nexport const desc = 'Query data';\n\nexport function builder(yargs) {\n    return yargs.option('model', {\n        describe:'the target model'\n    }).option('dev', {\n        default: false,\n        describe: 'enables development mode'\n    }).option('filter', {\n        default: null,\n        describe: 'defines query filter'\n    }).option('expand', {\n        default: null,\n        describe: 'defines query expand option'\n    }).option('group', {\n        default: null,\n        describe: 'defines query group by option'\n    }).option('top', {\n        default: 25,\n        describe: 'defines query top option'\n    }).option('skip', {\n        default: 0,\n        describe: 'defines query skip option'\n    }).option('count', {\n        default: false,\n        describe: 'defines query count option'\n    }).option('select', {\n        default: null,\n        describe: 'defines query select option'\n    }).option('order', {\n        default: null,\n        describe: 'defines query order by option'\n    }).option('out', {\n        default: null,\n        describe: 'defines the output file path'\n    }).option('state', {\n        default: 'none',\n        choices: ['none', 'insert', 'update', 'delete'],\n        describe: 'set state for data objects'\n    });\n}\n\nexport function handler(argv) {\n    let options = getConfiguration();\n    if (typeof argv.model === 'undefined' || argv.model === null) {\n        console.error('ERROR','The target cannot be empty');\n        process.exit(1);\n    }\n    if (argv.dev) {\n        //set development mode\n        process.env.NODE_ENV='development';\n    }\n    let app = getHttpApplication(options);\n    app.execute((context)=> {\n        try {\n            let model = context.model(argv.model);\n            if (typeof model === 'undefined' || model === null) {\n                console.error('ERROR','Target model cannot be found.');\n               return process.exit(1);\n            }\n            let query={};\n            QUERY_OPTS.forEach((x)=> {\n                if (argv.hasOwnProperty(x) && argv[x]) {\n                    query[`$${x}`] = argv[x];\n                }\n            });\n            //build query options\n            model.filter(query, (err, q)=> {\n                if (err) {\n                    console.error('ERROR','An error occurred while applying query.');\n                        console.error(err);\n                        return process.exit(1);\n                }\n                \n                let source = argv.count ? q.silent().getList() : q.silent().getItems();\n                return source.then((res)=> {\n                        if (res) {\n                            let finalResult = (argv.top === 1 && !argv.count) ? res[0] : res;\n\n                            if (argv.state !== 'none') {\n                                let state = argv.state === 'insert' ? 1 : argv.state === 'new' ? 1 :  argv.state === 'update' ? 2 : argv.state === 'delete' ? 4 : 0;\n                                if (state>0) {\n                                    if (Array.isArray(finalResult)) {\n                                        finalResult.forEach( x=> {\n                                            x.$state = state;\n                                        });\n                                    }\n                                    else if (typeof finalResult === 'object') {\n                                        finalResult.$state = state;\n                                    }\n                                }\n                            }\n                            if (argv.out) {\n                                let outFile = path.resolve(process.cwd(), argv.out);\n                                return fs.writeFile(outFile, JSON.stringify(finalResult,null,4),'utf8',(err)=> {\n                                    if (err) {\n                                        console.error('ERROR','An error occurred while writing output.');\n                                        console.error(err);\n                                        return process.exit(1);\n                                    }\n                                    console.error('INFO',`Data was succesfully exported to ${outFile}`);\n                                    return process.exit(0);\n                                });\n                            }\n                            else {\n                                console.log(JSON.stringify(finalResult,null,4));\n                            }\n                        }\n                        process.exit(0);\n                    }).catch((err)=> {\n                        console.error('ERROR','An error occurred while querying data.');\n                        console.error(err);\n                        return process.exit(1);\n                    });\n                \n            });\n        }\n        catch(err) {\n            console.error('ERROR','An error occurred while getting data.');\n            console.error(err);\n            process.exit(1);\n        }\n       \n    });\n}"]}