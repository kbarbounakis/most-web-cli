{"version":3,"sources":["util.js"],"names":["writeFileFromTemplate","loadConfiguration","getConfiguration","getDataConfiguration","getBuilder","getHttpApplication","_","ejs","fs","path","configurationDefaults","_dasherize","s","isString","trim","replace","toLowerCase","dasherize","mixin","source","dest","data","renderFile","then","res","Promise","resolve","reject","writeFile","err","config","require","process","cwd","Object","assign","code","console","error","exit","SimpleDataContext","configuration","strategyCtor","getStrategy","name","self","undefined","obj","DataConfigurationStrategy","model","isNil","classPath","eventListeners","dataModule","paths","DataModel","context","options","DataConfiguration","log","base","dataConfigurationStrategy","getModel","bind","ODataConventionModelBuilder","dataObjectModule","ModelClassLoaderStrategy","DataObject","HttpApplication","appModule","app","out","strategy","adapterTypes","configurationAdapterTypes","getSourceAt","Array","isArray","forEach","configurationAdapterType","invariantName","adapterModulePath","type","adapterModule","createInstance"],"mappings":"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","file":"util.js","sourcesContent":["import _ from 'lodash';\nimport ejs from 'ejs';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nconst configurationDefaults = {\n                \"base\":\"server\",\n                \"out\": \"dist/server\"\n            };\n\n/**\n *\n * @param s\n * @returns {*}\n * @private\n */\nfunction _dasherize(s) {\n    if (_.isString(s))\n        return _.trim(s).replace(/[_\\s]+/g, '-').replace(/([A-Z])/g, '-$1').replace(/-+/g, '-').replace(/^-/,'').toLowerCase();\n    return s;\n}\n\n/**\n * @method dasherize\n * @memberOf _\n */\nif (typeof _.dasherize !== 'function') {\n    _.mixin({'dasherize' : _dasherize});\n}\n\nexport function writeFileFromTemplate(source, dest, data) {\n    return ejs.renderFile(source, data).then((res)=> {\n        return new Promise((resolve, reject)=> {\n            //write file\n            fs.writeFile(dest, res, (err) => {\n              if (err) {\n                    return reject(err);\n              }\n              return resolve();\n            });\n        });\n        \n    });\n}\n\nexport function loadConfiguration() {\n    let config = require(path.resolve(process.cwd(), '.themost-cli.json'));\n    return Object.assign({}, configurationDefaults, config);\n}\n\nexport function getConfiguration() {\n    try {\n        return loadConfiguration();\n    }\n    catch(err) {\n        if (err.code === 'MODULE_NOT_FOUND') {\n            console.error('ERROR','Configuration cannot be found. It seems that current working directory does not contain a MOST Web Framework project.');\n            process.exit(1);\n        }\n        else {\n            console.error('ERROR','An error occurred while loading configuration.');\n            console.error(err);\n            process.exit(1);\n        }\n    }\n}\n\nexport class SimpleDataContext {\n    constructor(configuration) {\n        this.getConfiguration = ()=> configuration;\n    }\n   getStrategy(strategyCtor) {\n    return this.getConfiguration().getStrategy(strategyCtor);\n  }\n  \n  model(name) {\n    let self = this;\n    if ((name === null) || (name === undefined))\n        return null;\n    let obj = self.getConfiguration().getStrategy(function DataConfigurationStrategy() {}).model(name);\n    if (_.isNil(obj)) {\n        return null;\n    }\n    //do some things for CLI only\n    //remove class path if any\n    delete obj.classPath;\n    //clear event listeners\n    obj.eventListeners = [];\n    let dataModule = require.resolve('@themost/data/data-model',{\n            paths:[path.resolve(process.cwd(), 'node_modules')]\n        });\n    let DataModel = require(dataModule).DataModel,\n        model = new DataModel(obj);\n    //set model context\n    model.context = self;\n    //return model\n    return model;\n  }\n  \n}\n\nexport function getDataConfiguration(options) {\n    let DataConfiguration;\n    try {\n        let dataModule = require.resolve('@themost/data/data-configuration',{\n            paths:[path.resolve(process.cwd(), 'node_modules')]\n        });\n        DataConfiguration = require(dataModule).DataConfiguration;\n    }\n    catch(err) {\n        if (err.code === 'MODULE_NOT_FOUND') {\n            console.error('ERROR','MOST Web Framework data configuration module cannot be found.');\n        }\n        else {\n            console.error('ERROR','An error occurred while trying to initialize data configuration.');\n            console.error(err);\n        }\n        return process.exit(1);\n    }\n    console.log('INFO','Initializing configuration');\n    let res = new DataConfiguration(path.resolve(process.cwd(), options.base, 'config'));\n    //modify data configuration strategy\n    let dataConfigurationStrategy = res.getStrategy(function DataConfigurationStrategy() {});\n    let getModel = dataConfigurationStrategy.model;\n    dataConfigurationStrategy.model = function(name) {\n        let model = getModel.bind(this)(name);\n        if (model) {\n            //do some things for CLI only\n            //remove class path if any\n            delete model.classPath;\n            //clear event listeners\n            model.eventListeners = [];\n        }\n        return model;\n    };\n    \n    return res;\n    \n}\n\nexport function getBuilder(config) {\n    let ODataConventionModelBuilder;\n    let dataModule = require.resolve('@themost/data/odata',{\n            paths:[path.resolve(process.cwd(), 'node_modules')]\n        });\n    ODataConventionModelBuilder = require(dataModule).ODataConventionModelBuilder;\n    \n    let dataObjectModule = require.resolve('@themost/data/data-object',{\n            paths:[path.resolve(process.cwd(), 'node_modules')]\n        });\n    //disable data model class loader\n    config.getStrategy(function ModelClassLoaderStrategy() {}).resolve = function(model) {\n        return require(dataObjectModule).DataObject;\n    };\n    return new ODataConventionModelBuilder(config);\n}\n\nexport function getHttpApplication(options) {\n    let HttpApplication;\n    try {\n        let appModule = require.resolve('@themost/web/app',{\n            paths:[path.resolve(process.cwd(), 'node_modules')]\n        });\n        HttpApplication = require(appModule).HttpApplication;\n    }\n    catch(err) {\n        if (err.code === 'MODULE_NOT_FOUND') {\n            console.error('ERROR','MOST Web Framework module cannot be found.');\n        }\n        else {\n            console.error('ERROR','An error occurred while trying to initialize MOST Web Framework Application.');\n            console.error(err);\n        }\n        return process.exit(1);\n    }\n    console.log('INFO','Initializing application');\n    let app  = new HttpApplication(path.resolve(process.cwd(), options.out));\n        let strategy = app.getConfiguration().getStrategy(function DataConfigurationStrategy() {\n        });\n        //get adapter types\n        let adapterTypes = strategy.adapterTypes;\n        //get configuration adapter types\n        let configurationAdapterTypes = app.getConfiguration().getSourceAt('adapterTypes');\n        if (Array.isArray(configurationAdapterTypes)) {\n            configurationAdapterTypes.forEach((configurationAdapterType)=> {\n                if (typeof adapterTypes[configurationAdapterType.invariantName] === 'undefined') {\n                    //load adapter type\n                    let adapterModulePath = require.resolve(configurationAdapterType.type,{\n                        paths:[path.resolve(process.cwd(), 'node_modules')]\n                    });\n                    let adapterModule = require(adapterModulePath);\n                    adapterTypes[configurationAdapterType.invariantName] = {\n                        invariantName:configurationAdapterType.invariantName,\n                        name: configurationAdapterType.name,\n                        createInstance:adapterModule.createInstance\n                    };\n                }\n            });\n        }\n    return app;\n}"]}